datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum GameType {
  BIDA_1VS1      // Chế độ 2 người, tính ván thắng
  BIDA_DIEM_DEN  // Chế độ 3-4 người, tính điểm bi 3-6-9
  BIDA_BAI
}

model Room {
  id          Int      @id @default(autoincrement())
  name        String
  pin         String   // Mã PIN để xác thực quyền Player
  type        GameType @default(BIDA_DIEM_DEN)
  isFinished  Boolean  @default(false)
  
  // Cấu hình điểm cho bi (chỉ dùng nếu type là BIDA_DIEM_DEN)
  valBi3      Int      @default(1)
  valBi6      Int      @default(2)
  valBi9      Int      @default(3)

  // Quản lý bộ bài chung của cả phòng (Lưu dưới dạng mảng JSON các Card ID còn lại)
  // Ví dụ: [1, 5, 12, 22...]
  currentDeck Json?
  
  // Quan hệ
  players     Player[]
  history     History[]

  version     Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Player {
  id        Int      @id @default(autoincrement())
  name      String
  score     Int      @default(0)
  roomId    Int
  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  userId    Int?     // optional nếu player đã login
  // Cấu trúc Json: [{ "id": 1, "value": "A", "type": "Cơ", "isFlipped": false }, ...]
  cards     Json?    @default("[]")
  user      User?    @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model History {
  id        Int      @id @default(autoincrement())
  roomId    Int      
  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  content   String   
  rawLog    Json     
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Thêm các model khác nếu cần thiết
model User {
  id          Int      @id @default(autoincrement())
  email       String   @unique
  username    String
  password    String   // hash
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  players     Player[] // relation đến các ván họ tham gia
  sessions    Session[]
}

model Session {
  id         Int      @id @default(autoincrement())
  userId     Int
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token      String   // random token hoặc jwt refresh token
  expiresAt  DateTime
  createdAt  DateTime @default(now())
}